<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Poker Cash-Game Simulator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --panel-2:#0b1220;
      --text:#e5e7eb; --muted:#94a3b8; --accent:#22d3ee; --accent-2:#60a5fa;
      --good:#34d399; --bad:#f87171; --warn:#f59e0b; --border:#1f2937; --chip:#0a0f1d;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 800px at 80% -10%, #0b1220, #0f172a 40%), linear-gradient(180deg, #0b1220, #0f172a 60%);
      color:var(--text);
    }
    .wrap{ max-width:1100px; margin:40px auto; padding:0 16px; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:24px; }
    h1{
      font-size: clamp(22px, 3vw, 32px);
      letter-spacing:.3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .badge{ display:inline-block; padding:6px 10px; font-size:12px; border-radius:999px; background:#06202d; color:#7dd3fc; border:1px solid #0b2a3a; }
    .card{
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid var(--border); border-radius:14px; box-shadow: var(--shadow); padding:22px;
    }
    .grid{ display:grid; gap:18px; grid-template-columns: repeat(12, 1fr); }
    .grid-2col > *{ grid-column: span 12; }
    @media (min-width: 880px){ .grid-2col > *{ grid-column: span 6; } }

    label{ display:block; margin:8px 0 6px; color:var(--muted); font-size:14px; }
    input, textarea, select, button{
      width:100%; appearance:none; border:1px solid var(--border);
      background:#0b1020; color:var(--text);
      border-radius:10px; padding:10px 12px; font-size:15px;
      transition: box-shadow .2s ease, border-color .2s ease;
    }
    textarea{ min-height: 120px; line-height:1.35; }
    input:focus, textarea:focus{ outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(34,211,238,0.2); }
    .btn{ cursor:pointer; border:none; font-weight:600; letter-spacing:.2px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color:#0b1020; padding:12px 16px; border-radius:12px;
      box-shadow:0 6px 20px rgba(96,165,250,.25);
    }
    .btn:hover{ filter: brightness(1.06); }
    .section-title{ margin:22px 0 10px; font-weight:700; color:#cbd5e1; letter-spacing:.3px; }
    .muted{ color:var(--muted); }
    .error{ color:var(--bad); font-weight:600; margin-top:12px; }
    footer{ margin:36px 0 10px; color:var(--muted); font-size:13px; text-align:center; }

    .plots{ display:grid; gap:18px; grid-template-columns: repeat(12, 1fr); }
    .plots > figure{ grid-column: span 12; background:var(--chip); border:1px solid var(--border); border-radius:12px; padding:14px; }
    .plots figcaption{ margin:8px 0 8px; color:var(--muted); font-size:14px; }
    img{ width:100%; height:auto; border-radius:8px; display:block; }

    table{ width:100%; border-collapse: collapse; overflow:hidden; border-radius:12px; border:1px solid var(--border); background:var(--chip); }
    th, td{ padding:10px 12px; border-bottom:1px solid var(--border); font-size:14px; }
    th{ text-align:left; color:#cbd5e1; background:#0c1324; }
    tr:last-child td{ border-bottom:none; }

    .metrics-grid{ display:grid; gap:18px; grid-template-columns: repeat(12, 1fr); }
    .metrics-grid > .card{ grid-column: span 12; }
    @media (min-width: 1000px){ .metrics-grid > .card{ grid-column: span 4; } }

    .alert{
      border-radius:12px; padding:12px 14px; margin-bottom:10px; border:1px solid var(--border); background:#0a0f1d;
    }
    .alert.success{ border-left:4px solid var(--good); }
    .alert.warning{ border-left:4px solid var(--warn); }
    .alert.danger{ border-left:4px solid var(--bad); }
    .alert h4{ margin:0 0 6px 0; font-size:15px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ðŸŽ² Poker Cash-Game Simulator</h1>
      <div class="muted">Normal â€¢ Student-t â€¢ Bootstrap â€¢ Guardian â€¢ Scenario Lab â€¢ Alerts</div>
    </header>

    <!-- ================== SIMULATOR ================== -->
    <div class="card">
      <form method="POST" class="grid grid-2col" autocomplete="off">
        <input type="hidden" name="form_id" value="sim" />
        <div>
          <label for="num_samples">Sessions to simulate</label>
          <input type="number" id="num_samples" name="num_samples" value="200" min="1" required>
        </div>
        <div>
          <label for="mc_sims">Monte Carlo paths</label>
          <input type="number" id="mc_sims" name="mc_sims" value="3000" min="100" required>
        </div>
        <div>
          <label for="start_bankroll">Starting bankroll (currency or bb)</label>
          <input type="number" step="0.01" id="start_bankroll" name="start_bankroll" value="5000" required>
        </div>
        <div style="grid-column: span 12;">
          <label for="session_results">Session results (comma or space-separated)</label>
          <textarea id="session_results" name="session_results">{{ default_session_text }}</textarea>
        </div>
        <div style="grid-column: span 12; display:flex; justify-content:flex-end;">
          <button class="btn" type="submit">Run Simulation</button>
        </div>
      </form>
      {% if error %}<div class="error">{{ error }}</div>{% endif %}
    </div>

    {% if table_stats %}
      <h2 class="section-title">Historical Summary</h2>
      <div class="card">
        <table>
          <thead><tr><th>Metric</th><th>Value</th></tr></thead>
          <tbody>
            {% for row in table_stats %}
              <tr><td>{{ row.name }}</td><td>{{ row.value }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
        {% if plot_url_stat %}
          <div class="plots" style="margin-top:16px;">
            <figure>
              <figcaption>Historical Cumulative PnL</figcaption>
              <img src="{{ url_for('static', filename=plot_url_stat.split('static/')[-1]) }}?v={{ cb }}" alt="Historical">
            </figure>
          </div>
        {% endif %}
      </div>
    {% endif %}

    {% if metrics_normal and metrics_t and metrics_boot %}
      <h2 class="section-title">Monte Carlo Metrics</h2>
      <div class="metrics-grid">
        <div class="card">
          <h3 class="muted" style="margin-top:0;">Normal Distribution</h3>
          <table><thead><tr><th>Metric</th><th>Value</th></tr></thead>
          <tbody>{% for k, v in metrics_normal.items() %}<tr><td>{{ k }}</td><td>{{ v }}</td></tr>{% endfor %}</tbody></table>
        </div>
        <div class="card">
          <h3 class="muted" style="margin-top:0;">Student-t Distribution</h3>
          <table><thead><tr><th>Metric</th><th>Value</th></tr></thead>
          <tbody>{% for k, v in metrics_t.items() %}<tr><td>{{ k }}</td><td>{{ v }}</td></tr>{% endfor %}</tbody></table>
        </div>
        <div class="card">
          <h3 class="muted" style="margin-top:0;">Bootstrap Resampling</h3>
          <table><thead><tr><th>Metric</th><th>Value</th></tr></thead>
          <tbody>{% for k, v in metrics_boot.items() %}<tr><td>{{ k }}</td><td>{{ v }}</td></tr>{% endfor %}</tbody></table>
        </div>
      </div>
    {% endif %}

    {% if plot_url or plot_url_t or plot_url_boot %}
      <h2 class="section-title">Monte Carlo Paths</h2>
      <div class="card">
        <div class="plots">
          {% if plot_url %}
            <figure><figcaption>Normal Distribution</figcaption>
            <img src="{{ url_for('static', filename=plot_url.split('static/')[-1]) }}?v={{ cb }}" alt="Normal MC"></figure>
          {% endif %}
          {% if plot_url_t %}
            <figure><figcaption>Student-t Distribution</figcaption>
            <img src="{{ url_for('static', filename=plot_url_t.split('static/')[-1]) }}?v={{ cb }}" alt="Student-t MC"></figure>
          {% endif %}
          {% if plot_url_boot %}
            <figure><figcaption>Bootstrap Resampling</figcaption>
            <img src="{{ url_for('static', filename=plot_url_boot.split('static/')[-1]) }}?v={{ cb }}" alt="Bootstrap MC"></figure>
          {% endif %}
        </div>
      </div>
    {% endif %}

    <!-- ================== BANKROLL GUARDIAN (LIVE) ================== -->
    <h2 class="section-title">Bankroll Guardian <span class="badge">Live</span></h2>
    <div class="card">
      <form method="POST" class="grid grid-2col" autocomplete="off">
        <input type="hidden" name="form_id" value="guardian" />
        <div>
          <label>Target Risk of Ruin (max)</label>
          <input type="number" step="0.01" name="gr_target_ror" value="1.00" required>
          <div class="hint">Example: 1.00 means â‰¤ 1% RoR over the horizon.</div>
        </div>
        <div>
          <label>Horizon (sessions)</label>
          <input type="number" name="gr_sessions" value="200" min="10" required>
        </div>
        <div>
          <label>Monte Carlo paths</label>
          <input type="number" name="gr_paths" value="5000" min="1000" required>
        </div>
        <div>
          <label>Starting bankroll (currency)</label>
          <input type="number" step="0.01" name="gr_start_bankroll" value="5000" required>
        </div>
        <div>
          <label>Current BB value (currency per 1bb)</label>
          <input type="number" step="0.01" name="gr_current_bb" value="1.00" required>
          <div class="hint">If history is NL50 (bb=$0.50), enter 0.5; NL100 â†’ 1.0, etc.</div>
        </div>
        <div>
          <label>Search range for BB value</label>
          <div style="display:flex; gap:10px; align-items:center;">
            <input type="number" step="0.01" name="gr_search_min_bb" value="0.25" required>
            <span class="muted">to</span>
            <input type="number" step="0.01" name="gr_search_max_bb" value="3.00" required>
          </div>
        </div>
        <div style="grid-column: span 12; display:flex; justify-content:flex-end;">
          <button class="btn" type="submit">Recommend Stake</button>
        </div>
        <div style="grid-column: span 12;">
          <label for="session_results">Session results (reuse same history)</label>
          <textarea id="session_results" name="session_results">{{ default_session_text }}</textarea>
        </div>
      </form>

      {% if guardian_results %}
        <div class="grid" style="margin-top:16px;">
          <div style="grid-column: span 12;">
            <table>
              <thead><tr><th>Metric</th><th>Value</th></tr></thead>
              <tbody>
                <tr><td>Target RoR</td><td>{{ guardian_results["Target RoR"] }}</td></tr>
                <tr><td>Horizon (sessions)</td><td>{{ guardian_results["Horizon (sessions)"] }}</td></tr>
                <tr><td>Monte Carlo Paths</td><td>{{ guardian_results["Paths"] }}</td></tr>
                <tr><td>Recommended BB value</td><td>{{ guardian_results["Recommended BB value"] }}</td></tr>
                <tr><td>Implied stake vs current</td><td>{{ guardian_results["Implied stake vs current"] }}</td></tr>
                <tr><td>Estimated RoR at recommended stake</td><td>{{ guardian_results["Estimated RoR at rec stake"] }}</td></tr>
                <tr><td>Suggested per-session stop-loss</td><td>{{ guardian_results["Suggested per-session stop-loss"] }}</td></tr>
              </tbody>
            </table>
          </div>

          <div style="grid-column: span 12; margin-top:14px;">
            <h3 class="muted" style="margin:0 0 8px 0;">Metrics at Recommended Stake</h3>
            <table>
              <thead><tr><th>Metric</th><th>Value</th></tr></thead>
              <tbody>
                {% for k, v in guardian_results["metrics"].items() %}
                  <tr><td>{{ k }}</td><td>{{ v }}</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}
    </div>

    <!-- ================== SCENARIO LAB (LIVE) ================== -->
    <h2 class="section-title">Scenario Lab <span class="badge">Live</span></h2>
    <div class="card">
      <form method="POST" class="grid grid-2col" autocomplete="off">
        <input type="hidden" name="form_id" value="scenario" />
        <div>
          <label>Starting bankroll (currency)</label>
          <input type="number" step="0.01" name="sc_start_bankroll" value="5000" required>
        </div>
        <div>
          <label>Horizon (sessions)</label>
          <input type="number" name="sc_sessions" value="200" min="10" required>
        </div>
        <div>
          <label>Monte Carlo paths</label>
          <input type="number" name="sc_paths" value="5000" min="1000" required>
        </div>

        <div>
          <label>Current BB value (currency per 1bb)</label>
          <input type="number" step="0.01" name="sc_current_bb" value="1.00" required>
        </div>
        <div>
          <label>Scenario BB value (currency per 1bb)</label>
          <input type="number" step="0.01" name="sc_bb_value" value="1.00" required>
        </div>

        <div>
          <label>Winrate shift (bb/100)</label>
          <input type="number" step="0.1" name="sc_winrate_bb100" value="0.0" required>
          <div class="hint">e.g., +0.5 = improving winrate by 0.5 bb/100 at the scenario stake.</div>
        </div>
        <div>
          <label>Avg hands per session</label>
          <input type="number" name="sc_avg_hands" value="400" min="50" required>
          <div class="hint">Used to translate bb/100 into per-session currency.</div>
        </div>
        <div>
          <label>Volatility multiplier</label>
          <select name="sc_vol_mult">
            <option>0.8</option>
            <option selected>1.0</option>
            <option>1.2</option>
            <option>1.5</option>
          </select>
        </div>

        <div style="grid-column: span 12;">
          <label for="session_results">Session results (reuse same history)</label>
          <textarea id="session_results" name="session_results">{{ default_session_text }}</textarea>
        </div>

        <div style="grid-column: span 12; display:flex; justify-content:flex-end;">
          <button class="btn" type="submit">Run Scenario</button>
        </div>
      </form>

      {% if scenario_results %}
        <div class="grid" style="margin-top:16px;">
          <div style="grid-column: span 12;">
            <h3 class="muted" style="margin:0 0 8px 0;">Scenario Inputs</h3>
            <table>
              <thead><tr><th>Input</th><th>Value</th></tr></thead>
              <tbody>
                {% for k, v in scenario_results["inputs"].items() %}
                  <tr><td>{{ k }}</td><td>{{ v }}</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div style="grid-column: span 12; margin-top:14px;">
            <h3 class="muted" style="margin:0 0 8px 0;">Scenario Metrics</h3>
            <table>
              <thead><tr><th>Metric</th><th>Value</th></tr></thead>
              <tbody>
                {% for k, v in scenario_results["metrics"].items() %}
                  <tr><td>{{ k }}</td><td>{{ v }}</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {% if plot_url_scenario %}
            <div class="plots" style="grid-column: span 12; margin-top:16px;">
              <figure>
                <figcaption>Scenario Lab â€“ Cumulative Bankroll</figcaption>
                <img src="{{ url_for('static', filename=plot_url_scenario.split('static/')[-1]) }}?v={{ cb }}" alt="Scenario MC">
              </figure>
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>

    <!-- ================== ALERTS & NOTIFICATIONS (BETA) ================== -->
    <h2 class="section-title">Alerts & Notifications <span class="badge">Beta</span></h2>
    <div class="card">
      <!-- Guardian data payload for JS auto-fill -->
      <div id="guardian-data"
           data-available="{{ 'yes' if guardian_results else 'no' }}"
           {% if guardian_results %}
             data-start="{{ guardian_results['inputs']['start_bankroll'] }}"
             data-sessions="{{ guardian_results['inputs']['horizon_sessions'] }}"
             data-paths="{{ guardian_results['inputs']['paths'] }}"
             data-currentbb="{{ guardian_results['inputs']['current_bb_value'] }}"
             data-recommbb="{{ guardian_results['inputs']['recommended_bb_value'] }}"
           {% endif %}>
      </div>

      <form method="POST" class="grid grid-2col" autocomplete="off">
        <input type="hidden" name="form_id" value="alerts" />

        <!-- Policy / thresholds -->
        <div>
          <label>Stop-loss (per session)</label>
          <input type="number" step="0.01" name="al_stop_loss" value="500" required>
        </div>
        <div>
          <label>Weekly drawdown cap</label>
          <input type="number" step="0.01" name="al_week_cap" value="2000" required>
        </div>
        <div>
          <label>Risk of Ruin policy (%)</label>
          <input type="number" step="0.01" name="al_ror_limit" value="1.00" required>
        </div>

        <!-- Live / current -->
        <div>
          <label>Current session PnL (live)</label>
          <input type="number" step="0.01" name="al_current_pnl" value="0.0">
          <div class="hint">Enter negative numbers for losses (e.g., -350).</div>
        </div>
        <div>
          <label>Week-to-date PnL (quick entry)</label>
          <input type="number" step="0.01" name="al_week_pnl" placeholder="e.g., -800">
          <div class="hint">Optional if you donâ€™t provide the list below.</div>
        </div>
        <div style="grid-column: span 12;">
          <label>Last 7 sessions list (optional, overrides quick entry)</label>
          <textarea name="al_last7_list" placeholder="-200, 350, -150, 80, -600, 90, -50"></textarea>
        </div>

        <!-- RoR check: Add Use Guardian toggle -->
        <div style="grid-column: span 12;">
          <label style="display:flex; gap:10px; align-items:center;">
            <input type="checkbox" id="al_use_guardian" {% if not guardian_results %}disabled{% endif %}>
            Use Guardian recommendation (prefill stake, horizon, paths, start BR)
          </label>
          <div class="hint">{% if guardian_results %}Uses latest Guardian run above.{% else %}Run Guardian first to enable this.{% endif %}</div>
        </div>

        <!-- RoR check inputs -->
        <div>
          <label for="al_start_bankroll">RoR check â€“ Start bankroll</label>
          <input type="number" step="0.01" id="al_start_bankroll" name="al_start_bankroll" value="5000" required>
        </div>
        <div>
          <label for="al_sessions">RoR check â€“ Horizon (sessions)</label>
          <input type="number" id="al_sessions" name="al_sessions" value="200" min="10" required>
        </div>
        <div>
          <label for="al_paths">RoR check â€“ Paths</label>
          <input type="number" id="al_paths" name="al_paths" value="5000" min="1000" required>
        </div>
        <div>
          <label for="al_current_bb">RoR check â€“ Current BB value</label>
          <input type="number" step="0.01" id="al_current_bb" name="al_current_bb" value="1.00" required>
          <div class="hint">Currency per 1bb used in your history above.</div>
        </div>
        <div>
          <label for="al_bb_value">RoR check â€“ Stake BB value</label>
          <input type="number" step="0.01" id="al_bb_value" name="al_bb_value" value="1.00" required>
          <div class="hint">Stake you want to play now (currency per 1bb).</div>
        </div>

        <div style="grid-column: span 12;">
          <label for="session_results">Session results (reuse same history)</label>
          <textarea id="session_results" name="session_results">{{ default_session_text }}</textarea>
        </div>

        <div style="grid-column: span 12; display:flex; justify-content:flex-end;">
          <button class="btn" type="submit">Evaluate Alerts</button>
        </div>
      </form>

      {% if alerts_results %}
        <div style="margin-top:16px;">
          {% for a in alerts_results["alerts"] %}
            <div class="alert {{ a.severity }}">
              <h4>{{ a.title }}</h4>
              <div class="muted">{{ a.msg }}</div>
            </div>
          {% endfor %}
        </div>

        <div class="grid" style="margin-top:12px;">
          <div style="grid-column: span 12;">
            <h3 class="muted" style="margin:0 0 8px 0;">Alert Inputs</h3>
            <table>
              <thead><tr><th>Field</th><th>Value</th></tr></thead>
              <tbody>
                {% for k, v in alerts_results["inputs"].items() %}
                  <tr><td>{{ k }}</td><td>{{ v }}</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div style="grid-column: span 12; margin-top:12px;">
            <h3 class="muted" style="margin:0 0 8px 0;">Computed</h3>
            <table>
              <thead><tr><th>Metric</th><th>Value</th></tr></thead>
              <tbody>
                {% for k, v in alerts_results["derived"].items() %}
                  <tr><td>{{ k }}</td><td>{{ v }}</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}
    </div>

    <footer>Built for cash-game sessions â€¢ VaR/CVaR on total PnL (losses) â€¢ Max Drawdown â€¢ Guardian â€¢ Scenario Lab â€¢ Alerts</footer>
  </div>

  <!-- Tiny vanilla JS to auto-fill Alerts from Guardian -->
  <script>
    (function(){
      const payload = document.getElementById('guardian-data');
      if(!payload) return;

      const available = (payload.dataset.available === 'yes');
      const useCb = document.getElementById('al_use_guardian');
      if(!useCb) return;

      function applyGuardian() {
        if(!available || !useCb.checked) return;
        const start   = payload.dataset.start;
        const sess    = payload.dataset.sessions;
        const paths   = payload.dataset.paths;
        const curBB   = payload.dataset.currentbb;
        const recBB   = payload.dataset.recommbb;

        if(start)  document.getElementById('al_start_bankroll').value = start;
        if(sess)   document.getElementById('al_sessions').value = sess;
        if(paths)  document.getElementById('al_paths').value = paths;
        if(curBB)  document.getElementById('al_current_bb').value = curBB;
        if(recBB)  document.getElementById('al_bb_value').value = recBB;
      }

      useCb.addEventListener('change', applyGuardian);

      // (Optional) If the checkbox is enabled and already checked on load, apply immediately
      if(available && useCb.checked) applyGuardian();
    })();
  </script>
</body>
</html>
